<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Directo</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #0A0A0A;
            color: #FFFFFF;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        /* Color Palette */
        :root {
            --bg-primary: #0A0A0A;
            --bg-surface: #1A1A1A;
            --bg-row-alt: #121212;
            --accent: #FF6B35;
            --accent-favorites: #FFD700;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --text-disabled: #666666;
            --border-color: #333333;
            --divider-color: #2A2A2A;
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --success: #4CAF50;
            --error: #F44336;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 8px solid var(--border-color);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 32px;
            font-size: 36px;
            color: var(--text-secondary);
        }

        /* Disclaimer Screen */
        .disclaimer-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
            z-index: 9998;
        }

        .disclaimer-content {
            width: 60%;
            background: var(--bg-surface);
            padding: 48px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        .disclaimer-title {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 32px;
            text-align: center;
        }

        .disclaimer-text {
            font-size: 32px;
            line-height: 1.4;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        .disclaimer-buttons {
            display: flex;
            gap: 24px;
            justify-content: center;
        }

        /* Buttons */
        .btn {
            min-width: 200px;
            height: 72px;
            background: var(--bg-surface);
            color: var(--text-primary);
            font-size: 36px;
            font-weight: 500;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 200ms ease-out;
            padding: 0 32px;
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
        }

        .btn:focus, .btn.focused {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent);
            transform: scale(1.05);
        }

        /* Setup Screen */
        .setup-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
            z-index: 9997;
        }

        .setup-content {
            width: 50%;
            background: var(--bg-surface);
            padding: 48px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        .setup-title {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 32px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 32px;
        }

        .form-label {
            display: block;
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            height: 72px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 32px;
            padding: 0 24px;
            transition: border-color 200ms ease-out;
        }

        .form-input:focus, .form-input.focused {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.3);
        }

        .form-buttons {
            display: flex;
            gap: 24px;
            justify-content: center;
            margin-top: 40px;
        }

        /* Main App Layout */
        .app-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .dual-panel {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left Panel - Groups */
        .left-panel {
            width: 30%;
            background: var(--bg-surface);
            border-right: 1px solid var(--divider-color);
            overflow-y: auto;
            padding: 24px 32px;
        }

        .left-panel::-webkit-scrollbar {
            width: 8px;
        }

        .left-panel::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .group-item {
            padding: 24px 20px;
            font-size: 36px;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 150ms ease-out;
        }

        .group-item.favorites {
            font-size: 38px;
            font-weight: 500;
        }

        .group-item.selected {
            background: var(--accent);
            color: var(--text-primary);
            font-weight: 700;
            border-left: 5px solid var(--accent);
        }

        .group-item.focused:not(.selected) {
            background: rgba(255, 107, 53, 0.2);
            border: 2px solid var(--accent);
        }

        /* Right Panel - Channels */
        .right-panel {
            width: 70%;
            background: var(--bg-primary);
            overflow-y: auto;
            padding: 24px 40px;
        }

        .right-panel::-webkit-scrollbar {
            width: 8px;
        }

        .right-panel::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .channel-item {
            display: flex;
            align-items: center;
            height: 96px;
            padding: 0 24px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 150ms ease-out;
        }

        .channel-item:nth-child(even) {
            background: var(--bg-row-alt);
        }

        .channel-item.focused {
            background: var(--accent);
            box-shadow: 0 0 0 3px var(--accent);
        }

        .channel-number {
            width: 10%;
            font-size: 28px;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .channel-info {
            width: 60%;
        }

        .channel-name {
            font-size: 40px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .channel-program {
            font-size: 32px;
            color: var(--text-secondary);
        }

        .channel-time {
            width: 20%;
            font-size: 28px;
            color: var(--text-secondary);
            text-align: right;
        }

        .channel-favorite {
            width: 10%;
            text-align: right;
            font-size: 32px;
        }

        /* Footer Help Bar */
        .footer-bar {
            height: 5vh;
            background: var(--bg-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            font-size: 28px;
            color: var(--text-secondary);
            border-top: 1px solid var(--divider-color);
        }

        .footer-button {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .color-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-block;
        }

        .color-yellow { background: #FFD700; }
        .color-green { background: #4CAF50; }
        .color-red { background: #F44336; }

        /* Video Player */
        .video-player {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9996;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 25%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            opacity: 0;
            transition: opacity 200ms ease-in-out;
        }

        .video-overlay.visible {
            opacity: 1;
        }

        .video-channel-name {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .video-program-info {
            font-size: 36px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .video-controls {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-top: 16px;
            font-size: 32px;
        }

        /* Settings Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9995;
        }

        .modal-content {
            width: 50%;
            max-height: 60%;
            background: var(--bg-surface);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            overflow-y: auto;
        }

        .modal-title {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 32px;
            text-align: center;
        }

        .settings-item {
            padding: 24px;
            font-size: 36px;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 200ms ease-out;
            border: 2px solid transparent;
        }

        .settings-item.focused {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-surface);
            color: var(--text-primary);
            padding: 24px 48px;
            border-radius: 8px;
            font-size: 32px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            z-index: 10000;
            opacity: 0;
            transition: all 300ms ease-out;
        }

        .toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 36px;
        }

        .empty-icon {
            font-size: 96px;
            margin-bottom: 24px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen hidden">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Cargando...</div>
    </div>

    <!-- Disclaimer Screen -->
    <div id="disclaimerScreen" class="disclaimer-screen hidden">
        <div class="disclaimer-content">
            <h1 class="disclaimer-title" id="disclaimerTitle">Aviso Legal</h1>
            <div class="disclaimer-text" id="disclaimerText">
                Esta aplicación no proporciona ni respalda ninguna lista IPTV. Los usuarios son responsables de la legalidad de sus fuentes de contenido. Los desarrolladores no asumen ninguna responsabilidad por el contenido proporcionado por el usuario.
                <br><br>
                Al continuar, acepta estos términos.
            </div>
            <div class="disclaimer-buttons">
                <button class="btn btn-primary focused" id="btnAcceptDisclaimer">Aceptar</button>
                <button class="btn" id="btnExitApp">Salir</button>
            </div>
        </div>
    </div>

    <!-- Setup Screen -->
    <div id="setupScreen" class="setup-screen hidden">
        <div class="setup-content">
            <h1 class="setup-title" id="setupTitle">Agregar tu Lista IPTV</h1>
            <div class="form-group">
                <label class="form-label" id="labelUrl">URL de la Lista M3U</label>
                <input type="text" class="form-input focused" id="inputPlaylistUrl" placeholder="http://ejemplo.com/playlist.m3u">
            </div>
            <div class="form-group">
                <label class="form-label" id="labelName">Nombre de la Lista (opcional)</label>
                <input type="text" class="form-input" id="inputPlaylistName" placeholder="Mi Lista">
            </div>
            <div class="form-buttons">
                <button class="btn btn-primary" id="btnSavePlaylist">Guardar</button>
                <button class="btn" id="btnCancelSetup">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container hidden">
        <div class="dual-panel">
            <!-- Left Panel: Groups -->
            <div class="left-panel" id="leftPanel">
                <!-- Groups will be populated here -->
            </div>

            <!-- Right Panel: Channels -->
            <div class="right-panel" id="rightPanel">
                <!-- Channels will be populated here -->
            </div>
        </div>

        <!-- Footer Help Bar -->
        <div class="footer-bar">
            <div class="footer-button">
                <span class="color-btn color-yellow"></span>
                <span id="footerFavorites">Favoritos</span>
            </div>
            <div class="footer-button">
                <span class="color-btn color-green"></span>
                <span id="footerSettings">Ajustes</span>
            </div>
            <div class="footer-button">
                <span class="color-btn color-red"></span>
                <span id="footerBack">Volver</span>
            </div>
        </div>
    </div>

    <!-- Video Player -->
    <div id="videoPlayer" class="video-player hidden">
        <video id="videoElement" autoplay></video>
        <div class="video-overlay" id="videoOverlay">
            <div class="video-channel-name" id="videoChannelName">Canal Name</div>
            <div class="video-program-info" id="videoProgramInfo">Programa actual</div>
            <div class="video-controls">
                <span id="videoFavoriteHint">🟡 Agregar a Favoritos</span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="modal-title" id="settingsTitle">Ajustes</h2>
            <div id="settingsItems">
                <!-- Settings items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- webOS TV SDK -->
    <script src="webOSTVjs-1.2.10/webOSTV.js"></script>
    <script src="webOSTVjs-1.2.10/webOSTV-dev.js"></script>

    <!-- Main Application Script -->
    <script>
        // ==================== TRANSLATIONS ====================
        const translations = {
            es: {
                // Disclaimer
                disclaimerTitle: 'Aviso Legal',
                disclaimerText: 'Esta aplicación no proporciona ni respalda ninguna lista IPTV. Los usuarios son responsables de la legalidad de sus fuentes de contenido. Los desarrolladores no asumen ninguna responsabilidad por el contenido proporcionado por el usuario.\n\nAl continuar, acepta estos términos.',
                accept: 'Aceptar',
                exit: 'Salir',

                // Setup
                setupTitle: 'Agregar tu Lista IPTV',
                labelUrl: 'URL de la Lista M3U',
                labelName: 'Nombre de la Lista (opcional)',
                urlPlaceholder: 'http://ejemplo.com/playlist.m3u',
                namePlaceholder: 'Mi Lista',
                save: 'Guardar',
                cancel: 'Cancelar',

                // Loading
                loading: 'Cargando...',
                loadingChannels: 'Cargando canales...',

                // Footer
                favorites: 'Favoritos',
                settings: 'Ajustes',
                back: 'Volver',

                // Settings
                settingsTitle: 'Ajustes',
                language: 'Idioma / Language',
                listManagement: 'Gestión de Listas',
                about: 'Acerca de',
                legalDisclaimer: 'Aviso Legal',

                // Favorites
                myFavorites: '⭐ MIS FAVORITOS',
                addedToFavorites: 'Agregado a Favoritos',
                removedFromFavorites: 'Eliminado de Favoritos',
                addToFavorites: '🟡 Agregar a Favoritos',
                removeFromFavorites: '🟡 Quitar de Favoritos',

                // Errors
                errorLoadingPlaylist: 'Error al cargar la lista',
                invalidUrl: 'URL inválida',
                channelNotAvailable: 'Canal no disponible',

                // Empty states
                noChannels: 'No hay canales',
                noFavorites: 'No hay favoritos',
                selectGroup: 'Selecciona un grupo'
            },
            en: {
                // Disclaimer
                disclaimerTitle: 'Legal Disclaimer',
                disclaimerText: 'This application does not provide or endorse any IPTV lists. Users are responsible for the legality of their content sources. The developers assume no liability for user-provided content.\n\nBy continuing, you accept these terms.',
                accept: 'Accept',
                exit: 'Exit',

                // Setup
                setupTitle: 'Add Your IPTV List',
                labelUrl: 'M3U Playlist URL',
                labelName: 'List Name (optional)',
                urlPlaceholder: 'http://example.com/playlist.m3u',
                namePlaceholder: 'My List',
                save: 'Save',
                cancel: 'Cancel',

                // Loading
                loading: 'Loading...',
                loadingChannels: 'Loading channels...',

                // Footer
                favorites: 'Favorites',
                settings: 'Settings',
                back: 'Back',

                // Settings
                settingsTitle: 'Settings',
                language: 'Language / Idioma',
                listManagement: 'List Management',
                about: 'About',
                legalDisclaimer: 'Legal Disclaimer',

                // Favorites
                myFavorites: '⭐ MY FAVORITES',
                addedToFavorites: 'Added to Favorites',
                removedFromFavorites: 'Removed from Favorites',
                addToFavorites: '🟡 Add to Favorites',
                removeFromFavorites: '🟡 Remove from Favorites',

                // Errors
                errorLoadingPlaylist: 'Error loading playlist',
                invalidUrl: 'Invalid URL',
                channelNotAvailable: 'Channel not available',

                // Empty states
                noChannels: 'No channels',
                noFavorites: 'No favorites',
                selectGroup: 'Select a group'
            }
        };

        // ==================== STATE MANAGEMENT ====================
        class AppState {
            constructor() {
                this.currentLanguage = this.loadSettings().language || 'es';
                this.disclaimerAccepted = localStorage.getItem('iptv_disclaimer') === 'true';
                this.playlists = this.loadPlaylists();
                this.favorites = this.loadFavorites();
                this.currentPlaylist = null;
                this.currentGroup = null;
                this.channels = [];
                this.groups = [];
                this.focusedPanel = 'left'; // 'left' or 'right'
                this.focusedIndex = 0;
                this.isPlaying = false;
                this.currentChannel = null;
                this.showOverlay = false;
                this.overlayTimeout = null;
            }

            loadSettings() {
                const settings = localStorage.getItem('iptv_settings');
                return settings ? JSON.parse(settings) : { language: 'es' };
            }

            saveSettings(settings) {
                localStorage.setItem('iptv_settings', JSON.stringify(settings));
            }

            loadPlaylists() {
                const playlists = localStorage.getItem('iptv_playlists');
                return playlists ? JSON.parse(playlists) : [];
            }

            savePlaylists() {
                localStorage.setItem('iptv_playlists', JSON.stringify(this.playlists));
            }

            loadFavorites() {
                const favorites = localStorage.getItem('iptv_favorites');
                return favorites ? JSON.parse(favorites) : [];
            }

            saveFavorites() {
                localStorage.setItem('iptv_favorites', JSON.stringify(this.favorites));
            }

            acceptDisclaimer() {
                localStorage.setItem('iptv_disclaimer', 'true');
                this.disclaimerAccepted = true;
            }

            addPlaylist(url, name) {
                const playlist = {
                    id: this.generateId(),
                    name: name || 'Mi Lista',
                    url: url,
                    createdAt: new Date().toISOString(),
                    channels: []
                };
                this.playlists.push(playlist);
                this.savePlaylists();
                return playlist;
            }

            setCurrentPlaylist(playlist) {
                this.currentPlaylist = playlist;
                if (playlist && playlist.channels) {
                    this.channels = playlist.channels;
                    this.groups = this.extractGroups(playlist.channels);
                }
            }

            extractGroups(channels) {
                const groupSet = new Set();
                channels.forEach(channel => {
                    if (channel.groupTitle) {
                        groupSet.add(channel.groupTitle);
                    }
                });
                return Array.from(groupSet);
            }

            toggleFavorite(channelId) {
                const index = this.favorites.indexOf(channelId);
                if (index === -1) {
                    this.favorites.push(channelId);
                    this.saveFavorites();
                    return true; // added
                } else {
                    this.favorites.splice(index, 1);
                    this.saveFavorites();
                    return false; // removed
                }
            }

            isFavorite(channelId) {
                return this.favorites.includes(channelId);
            }

            generateId() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        }

        // ==================== M3U PARSER ====================
        class M3UParser {
            async fetchPlaylist(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('Failed to fetch playlist');
                    }
                    const text = await response.text();
                    return text;
                } catch (error) {
                    console.error('Error fetching playlist:', error);
                    throw error;
                }
            }

            parseM3U(m3uText) {
                const lines = m3uText.split('\n');
                const channels = [];
                let currentChannel = null;
                let channelNumber = 1;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();

                    if (line.startsWith('#EXTINF:')) {
                        // Parse channel info
                        currentChannel = this.parseExtInf(line, channelNumber);
                        channelNumber++;
                    } else if (line && !line.startsWith('#')) {
                        // This is the stream URL
                        if (currentChannel) {
                            currentChannel.streamUrl = line;
                            currentChannel.id = appState.generateId();
                            channels.push(currentChannel);
                            currentChannel = null;
                        }
                    }
                }

                return channels;
            }

            parseExtInf(line, number) {
                const channel = {
                    number: number,
                    name: '',
                    groupTitle: 'Sin Categoría',
                    logo: '',
                    streamUrl: ''
                };

                // Extract group-title
                const groupMatch = line.match(/group-title="([^"]*)"/);
                if (groupMatch) {
                    channel.groupTitle = groupMatch[1];
                }

                // Extract tvg-logo
                const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                if (logoMatch) {
                    channel.logo = logoMatch[1];
                }

                // Extract channel name (after last comma)
                const nameMatch = line.split(',');
                if (nameMatch.length > 1) {
                    channel.name = nameMatch[nameMatch.length - 1].trim();
                }

                return channel;
            }
        }

        // ==================== UI CONTROLLER ====================
        class UIController {
            constructor() {
                this.t = (key) => translations[appState.currentLanguage][key] || key;
            }

            showLoading(text) {
                const loadingScreen = document.getElementById('loadingScreen');
                const loadingText = document.getElementById('loadingText');
                loadingText.textContent = text || this.t('loading');
                loadingScreen.classList.remove('hidden');
            }

            hideLoading() {
                document.getElementById('loadingScreen').classList.add('hidden');
            }

            showDisclaimer() {
                const screen = document.getElementById('disclaimerScreen');
                document.getElementById('disclaimerTitle').textContent = this.t('disclaimerTitle');
                document.getElementById('disclaimerText').textContent = this.t('disclaimerText');
                document.getElementById('btnAcceptDisclaimer').textContent = this.t('accept');
                document.getElementById('btnExitApp').textContent = this.t('exit');
                screen.classList.remove('hidden');
            }

            hideDisclaimer() {
                document.getElementById('disclaimerScreen').classList.add('hidden');
            }

            showSetup() {
                const screen = document.getElementById('setupScreen');
                document.getElementById('setupTitle').textContent = this.t('setupTitle');
                document.getElementById('labelUrl').textContent = this.t('labelUrl');
                document.getElementById('labelName').textContent = this.t('labelName');
                document.getElementById('inputPlaylistUrl').placeholder = this.t('urlPlaceholder');
                document.getElementById('inputPlaylistName').placeholder = this.t('namePlaceholder');
                document.getElementById('btnSavePlaylist').textContent = this.t('save');
                document.getElementById('btnCancelSetup').textContent = this.t('cancel');
                screen.classList.remove('hidden');
            }

            hideSetup() {
                document.getElementById('setupScreen').classList.add('hidden');
            }

            showMainApp() {
                this.updateFooter();
                document.getElementById('mainApp').classList.remove('hidden');
            }

            hideMainApp() {
                document.getElementById('mainApp').classList.add('hidden');
            }

            updateFooter() {
                document.getElementById('footerFavorites').textContent = this.t('favorites');
                document.getElementById('footerSettings').textContent = this.t('settings');
                document.getElementById('footerBack').textContent = this.t('back');
            }

            renderGroups() {
                const leftPanel = document.getElementById('leftPanel');
                leftPanel.innerHTML = '';

                // Add Favorites group first
                const favDiv = document.createElement('div');
                favDiv.className = 'group-item favorites';
                favDiv.textContent = this.t('myFavorites');
                favDiv.dataset.group = 'FAVORITES';
                leftPanel.appendChild(favDiv);

                // Add other groups
                appState.groups.forEach(group => {
                    const div = document.createElement('div');
                    div.className = 'group-item';
                    div.textContent = group;
                    div.dataset.group = group;
                    leftPanel.appendChild(div);
                });

                // Select first group (Favorites)
                if (leftPanel.children.length > 0) {
                    appState.currentGroup = 'FAVORITES';
                    leftPanel.children[0].classList.add('selected', 'focused');
                    this.renderChannels();
                }
            }

            renderChannels() {
                const rightPanel = document.getElementById('rightPanel');
                rightPanel.innerHTML = '';

                let channelsToDisplay = [];

                if (appState.currentGroup === 'FAVORITES') {
                    channelsToDisplay = appState.channels.filter(ch =>
                        appState.isFavorite(ch.id)
                    );

                    if (channelsToDisplay.length === 0) {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'empty-state';
                        emptyDiv.innerHTML = `
                            <div class="empty-icon">⭐</div>
                            <div>${this.t('noFavorites')}</div>
                        `;
                        rightPanel.appendChild(emptyDiv);
                        return;
                    }
                } else {
                    channelsToDisplay = appState.channels.filter(ch =>
                        ch.groupTitle === appState.currentGroup
                    );
                }

                channelsToDisplay.forEach(channel => {
                    const div = document.createElement('div');
                    div.className = 'channel-item';
                    div.dataset.channelId = channel.id;

                    const favoriteIcon = appState.isFavorite(channel.id) ? '⭐' : '';

                    div.innerHTML = `
                        <div class="channel-number">${channel.number}</div>
                        <div class="channel-info">
                            <div class="channel-name">${channel.name}</div>
                            <div class="channel-program">-</div>
                        </div>
                        <div class="channel-time">-</div>
                        <div class="channel-favorite">${favoriteIcon}</div>
                    `;

                    rightPanel.appendChild(div);
                });

                // Focus first channel if switching panels
                if (appState.focusedPanel === 'right' && rightPanel.children.length > 0) {
                    appState.focusedIndex = 0;
                    rightPanel.children[0].classList.add('focused');
                }
            }

            showToast(message, duration = 3000) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('visible');

                setTimeout(() => {
                    toast.classList.remove('visible');
                }, duration);
            }

            showSettings() {
                const modal = document.getElementById('settingsModal');
                const settingsItems = document.getElementById('settingsItems');
                document.getElementById('settingsTitle').textContent = this.t('settingsTitle');

                settingsItems.innerHTML = `
                    <div class="settings-item focused" data-action="language">${this.t('language')}</div>
                    <div class="settings-item" data-action="list-management">${this.t('listManagement')}</div>
                    <div class="settings-item" data-action="about">${this.t('about')}</div>
                    <div class="settings-item" data-action="disclaimer">${this.t('legalDisclaimer')}</div>
                `;

                modal.classList.remove('hidden');
            }

            hideSettings() {
                document.getElementById('settingsModal').classList.add('hidden');
            }

            playChannel(channel) {
                appState.currentChannel = channel;
                appState.isPlaying = true;

                const videoPlayer = document.getElementById('videoPlayer');
                const videoElement = document.getElementById('videoElement');
                const overlay = document.getElementById('videoOverlay');

                // Update overlay info
                document.getElementById('videoChannelName').textContent = channel.name;
                document.getElementById('videoProgramInfo').textContent = channel.groupTitle;

                const favoriteText = appState.isFavorite(channel.id)
                    ? this.t('removeFromFavorites')
                    : this.t('addToFavorites');
                document.getElementById('videoFavoriteHint').textContent = favoriteText;

                // Set video source
                videoElement.src = channel.streamUrl;

                // Show player
                this.hideMainApp();
                videoPlayer.classList.remove('hidden');

                // Show overlay briefly
                this.showVideoOverlay();

                // Auto-hide overlay after 5 seconds
                this.autoHideOverlay();
            }

            stopPlayback() {
                const videoPlayer = document.getElementById('videoPlayer');
                const videoElement = document.getElementById('videoElement');

                videoElement.pause();
                videoElement.src = '';

                videoPlayer.classList.add('hidden');
                appState.isPlaying = false;
                appState.currentChannel = null;

                this.showMainApp();
            }

            showVideoOverlay() {
                const overlay = document.getElementById('videoOverlay');
                overlay.classList.add('visible');
                appState.showOverlay = true;
            }

            hideVideoOverlay() {
                const overlay = document.getElementById('videoOverlay');
                overlay.classList.remove('visible');
                appState.showOverlay = false;
            }

            autoHideOverlay() {
                if (appState.overlayTimeout) {
                    clearTimeout(appState.overlayTimeout);
                }

                appState.overlayTimeout = setTimeout(() => {
                    if (appState.isPlaying) {
                        this.hideVideoOverlay();
                    }
                }, 5000);
            }
        }

        // ==================== NAVIGATION CONTROLLER ====================
        class NavigationController {
            moveFocusUp() {
                if (!appState.isPlaying) {
                    const panel = appState.focusedPanel === 'left'
                        ? document.getElementById('leftPanel')
                        : document.getElementById('rightPanel');

                    const items = Array.from(panel.children).filter(el =>
                        el.classList.contains('group-item') || el.classList.contains('channel-item')
                    );

                    if (items.length > 0) {
                        items[appState.focusedIndex].classList.remove('focused');
                        appState.focusedIndex = (appState.focusedIndex - 1 + items.length) % items.length;
                        items[appState.focusedIndex].classList.add('focused');
                        items[appState.focusedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                }
            }

            moveFocusDown() {
                if (!appState.isPlaying) {
                    const panel = appState.focusedPanel === 'left'
                        ? document.getElementById('leftPanel')
                        : document.getElementById('rightPanel');

                    const items = Array.from(panel.children).filter(el =>
                        el.classList.contains('group-item') || el.classList.contains('channel-item')
                    );

                    if (items.length > 0) {
                        items[appState.focusedIndex].classList.remove('focused');
                        appState.focusedIndex = (appState.focusedIndex + 1) % items.length;
                        items[appState.focusedIndex].classList.add('focused');
                        items[appState.focusedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                }
            }

            moveFocusLeft() {
                if (!appState.isPlaying && appState.focusedPanel === 'right') {
                    // Move focus from right to left panel
                    const rightPanel = document.getElementById('rightPanel');
                    const leftPanel = document.getElementById('leftPanel');

                    const rightItems = Array.from(rightPanel.children);
                    if (rightItems[appState.focusedIndex]) {
                        rightItems[appState.focusedIndex].classList.remove('focused');
                    }

                    appState.focusedPanel = 'left';
                    appState.focusedIndex = 0;

                    const leftItems = Array.from(leftPanel.children);
                    if (leftItems[0]) {
                        leftItems[0].classList.add('focused');
                    }
                }
            }

            moveFocusRight() {
                if (!appState.isPlaying && appState.focusedPanel === 'left') {
                    // Move focus from left to right panel
                    const leftPanel = document.getElementById('leftPanel');
                    const rightPanel = document.getElementById('rightPanel');

                    const leftItems = Array.from(leftPanel.children);
                    if (leftItems[appState.focusedIndex]) {
                        leftItems[appState.focusedIndex].classList.remove('focused');
                    }

                    appState.focusedPanel = 'right';
                    appState.focusedIndex = 0;

                    const rightItems = Array.from(rightPanel.children);
                    if (rightItems[0]) {
                        rightItems[0].classList.add('focused');
                    }
                }
            }

            selectCurrent() {
                if (appState.isPlaying) {
                    return; // In playback mode, OK doesn't do anything
                }

                if (appState.focusedPanel === 'left') {
                    // Select group
                    const leftPanel = document.getElementById('leftPanel');
                    const items = Array.from(leftPanel.children);
                    const selectedGroup = items[appState.focusedIndex];

                    if (selectedGroup) {
                        // Remove selected class from all groups
                        items.forEach(item => item.classList.remove('selected'));
                        selectedGroup.classList.add('selected');

                        appState.currentGroup = selectedGroup.dataset.group;
                        ui.renderChannels();
                    }
                } else if (appState.focusedPanel === 'right') {
                    // Play channel
                    const rightPanel = document.getElementById('rightPanel');
                    const items = Array.from(rightPanel.children);
                    const selectedChannel = items[appState.focusedIndex];

                    if (selectedChannel && selectedChannel.dataset.channelId) {
                        const channel = appState.channels.find(ch => ch.id === selectedChannel.dataset.channelId);
                        if (channel) {
                            ui.playChannel(channel);
                        }
                    }
                }
            }

            toggleFavorite() {
                if (appState.isPlaying && appState.currentChannel) {
                    // Toggle favorite for current playing channel
                    const added = appState.toggleFavorite(appState.currentChannel.id);
                    const message = added ? ui.t('addedToFavorites') : ui.t('removedFromFavorites');
                    ui.showToast(message);

                    // Update overlay text
                    const favoriteText = appState.isFavorite(appState.currentChannel.id)
                        ? ui.t('removeFromFavorites')
                        : ui.t('addToFavorites');
                    document.getElementById('videoFavoriteHint').textContent = favoriteText;
                } else if (!appState.isPlaying && appState.focusedPanel === 'right') {
                    // Toggle favorite for focused channel
                    const rightPanel = document.getElementById('rightPanel');
                    const items = Array.from(rightPanel.children);
                    const selectedChannel = items[appState.focusedIndex];

                    if (selectedChannel && selectedChannel.dataset.channelId) {
                        const channel = appState.channels.find(ch => ch.id === selectedChannel.dataset.channelId);
                        if (channel) {
                            const added = appState.toggleFavorite(channel.id);
                            const message = added ? ui.t('addedToFavorites') : ui.t('removedFromFavorites');
                            ui.showToast(message);

                            // Update UI
                            ui.renderChannels();
                        }
                    }
                }
            }

            handleBack() {
                if (appState.isPlaying) {
                    ui.stopPlayback();
                }
            }
        }

        // ==================== INITIALIZATION ====================
        let appState, ui, navigation, parser;

        async function initializeApp() {
            // Initialize instances
            appState = new AppState();
            ui = new UIController();
            navigation = new NavigationController();
            parser = new M3UParser();

            // Check disclaimer
            if (!appState.disclaimerAccepted) {
                ui.showDisclaimer();
                return;
            }

            // Check if we have playlists
            if (appState.playlists.length === 0) {
                ui.showSetup();
                return;
            }

            // Load first playlist and show main app
            await loadPlaylist(appState.playlists[0]);
        }

        async function loadPlaylist(playlist) {
            try {
                ui.showLoading(ui.t('loadingChannels'));

                const m3uText = await parser.fetchPlaylist(playlist.url);
                const channels = parser.parseM3U(m3uText);

                playlist.channels = channels;
                appState.setCurrentPlaylist(playlist);

                ui.hideLoading();
                ui.showMainApp();
                ui.renderGroups();
            } catch (error) {
                ui.hideLoading();
                ui.showToast(ui.t('errorLoadingPlaylist'));
                console.error('Error loading playlist:', error);
            }
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();

            // Disclaimer buttons
            document.getElementById('btnAcceptDisclaimer').addEventListener('click', function() {
                appState.acceptDisclaimer();
                ui.hideDisclaimer();

                if (appState.playlists.length === 0) {
                    ui.showSetup();
                } else {
                    loadPlaylist(appState.playlists[0]);
                }
            });

            document.getElementById('btnExitApp').addEventListener('click', function() {
                window.close();
            });

            // Setup form
            document.getElementById('btnSavePlaylist').addEventListener('click', async function() {
                const url = document.getElementById('inputPlaylistUrl').value;
                const name = document.getElementById('inputPlaylistName').value || 'Mi Lista';

                if (!url) {
                    ui.showToast(ui.t('invalidUrl'));
                    return;
                }

                const playlist = appState.addPlaylist(url, name);
                ui.hideSetup();
                await loadPlaylist(playlist);
            });

            document.getElementById('btnCancelSetup').addEventListener('click', function() {
                if (appState.playlists.length > 0) {
                    ui.hideSetup();
                    loadPlaylist(appState.playlists[0]);
                }
            });

            // Keyboard navigation
            document.addEventListener('keydown', function(event) {
                console.log('Key pressed:', event.key, event.keyCode);

                switch(event.key) {
                    case 'ArrowUp':
                        navigation.moveFocusUp();
                        if (appState.isPlaying && appState.showOverlay) {
                            ui.autoHideOverlay();
                        }
                        break;
                    case 'ArrowDown':
                        navigation.moveFocusDown();
                        if (appState.isPlaying && appState.showOverlay) {
                            ui.autoHideOverlay();
                        }
                        break;
                    case 'ArrowLeft':
                        navigation.moveFocusLeft();
                        break;
                    case 'ArrowRight':
                        navigation.moveFocusRight();
                        break;
                    case 'Enter':
                        navigation.selectCurrent();
                        break;
                    case 'Backspace': // Back button
                    case 'Escape':
                        navigation.handleBack();
                        break;
                }

                // Handle colored buttons (webOS remote)
                // Yellow button (406)
                if (event.keyCode === 406) {
                    navigation.toggleFavorite();
                    if (appState.isPlaying) {
                        ui.showVideoOverlay();
                        ui.autoHideOverlay();
                    }
                }

                // Green button (405)
                if (event.keyCode === 405) {
                    ui.showSettings();
                }

                // Show overlay on any button press during playback
                if (appState.isPlaying && !appState.showOverlay) {
                    ui.showVideoOverlay();
                    ui.autoHideOverlay();
                }

                event.preventDefault();
            });
        });
    </script>
</body>
</html>
